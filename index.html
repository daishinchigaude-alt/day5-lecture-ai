<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="è¬›ç¾©ã®éŒ²éŸ³ã‚’AIã§æ–‡å­—èµ·ã“ã—ãƒ»è¦ç´„ãƒ»è¦ç‚¹æ•´ç†ã™ã‚‹Webã‚¢ãƒ—ãƒª">
  <title>è¬›ç¾©ãƒãƒ¼ãƒˆAI</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;600;700&display=swap"
    rel="stylesheet">
  <style>
    body {
      font-family: 'Noto Sans JP', sans-serif;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    @keyframes pulse {

      0%,
      100% {
        opacity: 1;
      }

      50% {
        opacity: .5;
      }
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(12px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .loader {
      width: 52px;
      height: 52px;
      border: 4px solid #c7d2fe;
      border-top-color: #6366f1;
      border-radius: 50%;
      animation: spin .7s linear infinite;
    }

    .pulse {
      animation: pulse 2s ease-in-out infinite;
    }

    .fade-in {
      animation: fadeIn .4s ease-out;
    }
  </style>
</head>

<body class="bg-slate-50 min-h-screen flex flex-col">

  <!-- ========== ãƒ˜ãƒƒãƒ€ãƒ¼ ========== -->
  <header class="sticky top-0 z-30 bg-gradient-to-r from-indigo-600 via-violet-600 to-purple-600 text-white shadow-lg">
    <div class="max-w-2xl mx-auto px-4 py-3 flex items-center justify-between">
      <h1 class="text-lg sm:text-xl font-bold tracking-tight">ğŸ“ è¬›ç¾©ãƒãƒ¼ãƒˆAI</h1>
      <button onclick="openSettings()" class="p-2 rounded-lg hover:bg-white/20 active:bg-white/30 transition"
        aria-label="è¨­å®š">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round"
            d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.066 2.573c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.573 1.066c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.066-2.573c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.573-1.066z" />
          <circle cx="12" cy="12" r="3" />
        </svg>
      </button>
    </div>
  </header>

  <!-- ========== ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ ========== -->
  <main class="flex-1 w-full max-w-2xl mx-auto px-4 py-6 space-y-5">

    <!-- ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚«ãƒ¼ãƒ‰ -->
    <section class="bg-white rounded-2xl shadow border border-slate-200 p-5 sm:p-6 space-y-4">
      <h2 class="font-semibold text-slate-800 flex items-center gap-2 text-[15px]">ğŸ“ éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</h2>

      <label id="dropZone"
        class="relative flex flex-col items-center gap-2 border-2 border-dashed border-slate-300 rounded-xl p-6 sm:p-8 cursor-pointer hover:border-indigo-400 hover:bg-indigo-50/40 transition-all text-center">
        <input type="file" id="fileInput" class="sr-only" accept="audio/*,.m4a,.mp3,.wav,.ogg,.flac,.aac,.aiff,.webm">
        <!-- æœªé¸æŠæ™‚ -->
        <div id="emptyState">
          <svg class="mx-auto mb-1 text-indigo-400" width="36" height="36" fill="none" stroke="currentColor"
            stroke-width="1.5" viewBox="0 0 24 24">
            <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4" />
            <polyline points="17 8 12 3 7 8" />
            <line x1="12" y1="3" x2="12" y2="15" />
          </svg>
          <p class="text-sm font-medium text-slate-600">ã‚¿ãƒƒãƒ—ã—ã¦ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ</p>
          <p class="text-xs text-slate-400 mt-0.5">WAV / MP3 / M4A / AAC / OGG / FLAC ç­‰</p>
        </div>
        <!-- é¸æŠæ¸ˆã¿ -->
        <div id="fileState" class="hidden w-full">
          <div class="flex items-center gap-3 text-left">
            <span class="text-3xl shrink-0">ğŸµ</span>
            <div class="min-w-0 flex-1">
              <p id="fName" class="text-sm font-medium text-slate-700 truncate"></p>
              <p id="fSize" class="text-xs text-slate-400"></p>
            </div>
            <button type="button" onclick="event.preventDefault();clearFile()"
              class="shrink-0 w-8 h-8 rounded-full bg-red-50 text-red-400 hover:bg-red-100 hover:text-red-600 transition flex items-center justify-center text-xs font-bold">âœ•</button>
          </div>
        </div>
      </label>

      <button id="runBtn" onclick="analyze()" disabled
        class="w-full py-3 rounded-xl font-semibold text-white bg-gradient-to-r from-indigo-500 to-violet-500 hover:from-indigo-600 hover:to-violet-600 disabled:from-slate-300 disabled:to-slate-300 disabled:cursor-not-allowed transition-all shadow-sm active:scale-[0.98] flex items-center justify-center gap-2 text-[15px]">
        â–¶ ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆã™ã‚‹
      </button>
    </section>

    <!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° -->
    <section id="loading" class="hidden bg-white rounded-2xl shadow border border-slate-200 p-8">
      <div class="flex flex-col items-center gap-3">
        <div class="loader"></div>
        <p id="loadMsg" class="text-sm font-semibold text-slate-700 pulse">AIãŒè§£æä¸­...</p>
        <p class="text-xs text-slate-400">éŸ³å£°ã®é•·ã•ã«ã‚ˆã‚Šæ•°åç§’ã€œæ•°åˆ†ã‹ã‹ã‚Šã¾ã™</p>
      </div>
    </section>

    <!-- ã‚¨ãƒ©ãƒ¼ -->
    <div id="errBox" class="hidden bg-red-50 border border-red-200 rounded-xl p-4 fade-in">
      <p class="text-sm font-semibold text-red-700 mb-1">âš ï¸ ã‚¨ãƒ©ãƒ¼</p>
      <pre id="errMsg" class="text-sm text-red-600 whitespace-pre-wrap break-words"></pre>
    </div>

    <!-- ===== çµæœ ===== -->
    <div id="results" class="hidden space-y-4 fade-in">

      <!-- è¦ç´„ -->
      <div class="bg-white rounded-2xl shadow border border-slate-200 overflow-hidden">
        <div class="flex items-center justify-between px-5 py-3 bg-slate-50 border-b border-slate-100">
          <h3 class="text-sm font-semibold text-slate-700">ğŸ“ è¦ç´„</h3>
          <button onclick="copyText('outSummary',this)"
            class="text-xs text-indigo-500 hover:text-indigo-700 font-medium px-2 py-1 rounded hover:bg-indigo-50 transition">ğŸ“‹
            ã‚³ãƒ”ãƒ¼</button>
        </div>
        <div id="outSummary" class="px-5 py-4 text-sm text-slate-700 leading-relaxed whitespace-pre-wrap"></div>
      </div>

      <!-- è¦ç‚¹ -->
      <div class="bg-white rounded-2xl shadow border border-slate-200 overflow-hidden">
        <div class="flex items-center justify-between px-5 py-3 bg-slate-50 border-b border-slate-100">
          <h3 class="text-sm font-semibold text-slate-700">ğŸ’¡ è¦ç‚¹</h3>
          <button onclick="copyText('outPoints',this)"
            class="text-xs text-indigo-500 hover:text-indigo-700 font-medium px-2 py-1 rounded hover:bg-indigo-50 transition">ğŸ“‹
            ã‚³ãƒ”ãƒ¼</button>
        </div>
        <div id="outPoints" class="px-5 py-4 text-sm text-slate-700 leading-relaxed whitespace-pre-wrap"></div>
      </div>

      <!-- æ–‡å­—èµ·ã“ã— -->
      <div class="bg-white rounded-2xl shadow border border-slate-200 overflow-hidden">
        <div class="flex items-center justify-between px-5 py-3 bg-slate-50 border-b border-slate-100">
          <h3 class="text-sm font-semibold text-slate-700">ğŸ“„ æ–‡å­—èµ·ã“ã—ï¼ˆå…¨æ–‡ï¼‰</h3>
          <button onclick="copyText('outFull',this)"
            class="text-xs text-indigo-500 hover:text-indigo-700 font-medium px-2 py-1 rounded hover:bg-indigo-50 transition">ğŸ“‹
            ã‚³ãƒ”ãƒ¼</button>
        </div>
        <details>
          <summary
            class="px-5 py-3 text-xs text-indigo-500 font-medium cursor-pointer select-none hover:bg-indigo-50/50 transition">
            â–¼ å…¨æ–‡ã‚’è¡¨ç¤º</summary>
          <div id="outFull"
            class="px-5 py-4 text-sm text-slate-600 leading-relaxed whitespace-pre-wrap border-t border-slate-100 max-h-[28rem] overflow-y-auto">
          </div>
        </details>
      </div>

      <!-- å…¨çµæœã‚³ãƒ”ãƒ¼ -->
      <button onclick="copyAll(this)"
        class="w-full py-3 rounded-xl font-semibold text-indigo-600 bg-indigo-50 hover:bg-indigo-100 border border-indigo-200 transition-all active:scale-[0.98] flex items-center justify-center gap-2 text-sm">
        ğŸ“‹ ã™ã¹ã¦ã®çµæœã‚’ã‚³ãƒ”ãƒ¼
      </button>

      <!-- ç”Ÿãƒ¬ã‚¹ãƒãƒ³ã‚¹ï¼ˆãƒ‡ãƒãƒƒã‚°ï¼‰ -->
      <details class="bg-white rounded-2xl shadow border border-slate-200 overflow-hidden">
        <summary
          class="px-5 py-3 text-xs text-slate-400 font-medium cursor-pointer select-none hover:bg-slate-50 transition">
          ğŸ” AIã®ç”Ÿãƒ¬ã‚¹ãƒãƒ³ã‚¹</summary>
        <pre id="outRaw"
          class="px-5 py-4 text-[11px] text-slate-500 whitespace-pre-wrap break-words border-t border-slate-100 max-h-60 overflow-y-auto font-mono leading-relaxed"></pre>
      </details>
    </div>

  </main>

  <!-- ãƒ•ãƒƒã‚¿ãƒ¼ -->
  <footer class="text-center py-4 text-xs text-slate-400 border-t border-slate-100">Powered by Gemini API
    (gemini-2.0-flash)</footer>

  <!-- ========== APIã‚­ãƒ¼è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ« ========== -->
  <div id="modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/40">
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm overflow-hidden fade-in">
      <div class="px-5 py-4 border-b border-slate-100 flex items-center justify-between">
        <h2 class="font-bold text-slate-800 text-[15px]">âš™ï¸ APIè¨­å®š</h2>
        <button onclick="closeSettings()"
          class="w-7 h-7 rounded-full hover:bg-slate-100 flex items-center justify-center text-slate-400 hover:text-slate-600 transition text-sm">âœ•</button>
      </div>
      <div class="px-5 py-4 space-y-3">
        <p class="text-xs text-slate-500 leading-relaxed">Gemini APIã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚ã“ã®ç«¯æœ«ã®ãƒ–ãƒ©ã‚¦ã‚¶ã«ã®ã¿ä¿å­˜ã•ã‚Œã¾ã™ã€‚</p>
        <input type="password" id="keyInput"
          class="w-full px-3 py-2.5 text-sm border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-200 focus:border-indigo-400 outline-none transition"
          placeholder="AIza...">
        <a href="https://aistudio.google.com/apikey" target="_blank"
          class="inline-block text-xs text-indigo-500 hover:text-indigo-700 font-medium">ğŸ”‘ APIã‚­ãƒ¼ã‚’å–å¾—ï¼ˆGoogle AI
          Studioï¼‰</a>
      </div>
      <div class="px-5 py-4 border-t border-slate-100 bg-slate-50/50">
        <button onclick="saveKey()"
          class="w-full py-2.5 rounded-lg font-semibold text-white bg-gradient-to-r from-indigo-500 to-violet-500 hover:from-indigo-600 hover:to-violet-600 text-sm transition">ä¿å­˜ã™ã‚‹</button>
      </div>
    </div>
  </div>

  <!-- ãƒˆãƒ¼ã‚¹ãƒˆ -->
  <div id="toast"
    class="hidden fixed bottom-6 left-1/2 -translate-x-1/2 z-50 bg-slate-800 text-white text-sm px-4 py-2.5 rounded-full shadow-lg">
    âœ… ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ</div>

  <!-- ========================================== -->
  <!-- JavaScript                                 -->
  <!-- ========================================== -->
  <script>
    // ===== å®šæ•° =====
    // gemini-2.0-flashï¼ˆv1betaï¼‰ã‚’ä½¿ç”¨
    // â€» gemini-1.5-flash ã¯2025å¹´8æœˆã«å»ƒæ­¢æ¸ˆã¿
    const API_BASE = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent';
    const LS_KEY = 'lecture-note-ai-key';

    // ===== DOM =====
    const fileInput = document.getElementById('fileInput');
    let pickedFile = null;

    // ===== è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ« =====
    function openSettings() {
      document.getElementById('keyInput').value = localStorage.getItem(LS_KEY) || '';
      document.getElementById('modal').classList.remove('hidden');
    }
    function closeSettings() { document.getElementById('modal').classList.add('hidden'); }
    function saveKey() {
      const k = document.getElementById('keyInput').value.trim();
      if (!k) { document.getElementById('keyInput').focus(); return; }
      localStorage.setItem(LS_KEY, k);
      closeSettings();
    }

    // ===== ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠ =====
    fileInput.addEventListener('change', () => {
      const f = fileInput.files[0];
      if (!f) return;
      if (f.size > 15 * 1024 * 1024) {
        showErr('ãƒ•ã‚¡ã‚¤ãƒ«ãŒå¤§ãã™ãã¾ã™ï¼ˆä¸Šé™15MBï¼‰ã€‚\nBase64å¤‰æ›å¾Œã«20MBã‚’è¶…ãˆã‚‹ã¨APIãŒæ‹’å¦ã—ã¾ã™ã€‚');
        fileInput.value = '';
        return;
      }
      pickedFile = f;
      document.getElementById('fName').textContent = f.name;
      document.getElementById('fSize').textContent = (f.size / 1024 / 1024).toFixed(1) + ' MB';
      document.getElementById('emptyState').classList.add('hidden');
      document.getElementById('fileState').classList.remove('hidden');
      document.getElementById('runBtn').disabled = false;
      hideErr();
    });

    function clearFile() {
      pickedFile = null;
      fileInput.value = '';
      document.getElementById('emptyState').classList.remove('hidden');
      document.getElementById('fileState').classList.add('hidden');
      document.getElementById('runBtn').disabled = true;
    }

    // ===== Base64å¤‰æ› =====
    function toBase64(file) {
      return new Promise((ok, ng) => {
        const r = new FileReader();
        r.onload = () => ok(r.result.split(',')[1]);
        r.onerror = () => ng(new Error('ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿å¤±æ•—'));
        r.readAsDataURL(file);
      });
    }

    // ===== MIMEã‚¿ã‚¤ãƒ—åˆ¤å®š =====
    function getMime(file) {
      const ext = file.name.split('.').pop().toLowerCase();
      const map = {
        mp3: 'audio/mp3', wav: 'audio/wav', ogg: 'audio/ogg',
        flac: 'audio/flac', aac: 'audio/aac', aiff: 'audio/aiff',
        m4a: 'audio/mp4', mp4: 'audio/mp4', webm: 'audio/webm',
      };
      return map[ext] || file.type || 'audio/mp4';
    }

    // ===== ãƒ¡ã‚¤ãƒ³è§£æå‡¦ç† =====
    async function analyze() {
      const apiKey = localStorage.getItem(LS_KEY);
      if (!apiKey) { openSettings(); return; }
      if (!pickedFile) { showErr('éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚'); return; }

      const btn = document.getElementById('runBtn');
      const loading = document.getElementById('loading');

      try {
        // UI: ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°é–‹å§‹
        btn.disabled = true;
        hideErr();
        document.getElementById('results').classList.add('hidden');
        loading.classList.remove('hidden');

        // 1) Base64ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰
        document.getElementById('loadMsg').textContent = 'ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿ä¸­...';
        const b64 = await toBase64(pickedFile);
        const mime = getMime(pickedFile);

        // 2) APIå‘¼ã³å‡ºã—
        document.getElementById('loadMsg').textContent = 'AIãŒè§£æä¸­...';

        const prompt = 'ã“ã®éŸ³å£°ã‚’è§£æã—ã¦ã€ä»¥ä¸‹ã®3ã¤ã‚’ã™ã¹ã¦æ—¥æœ¬èªã§å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚\n\n' +
          'ã€æ–‡å­—èµ·ã“ã—ã€‘\néŸ³å£°ã®å…¨æ–‡ã‚’æ­£ç¢ºã«æ–‡å­—èµ·ã“ã—ã—ã¦ãã ã•ã„ã€‚\n\n' +
          'ã€è¦ç´„ã€‘\nå†…å®¹ã‚’3è¡Œã§ç°¡æ½”ã«ã¾ã¨ã‚ã¦ãã ã•ã„ã€‚\n\n' +
          'ã€è¦ç‚¹ã€‘\né‡è¦ãªãƒã‚¤ãƒ³ãƒˆã‚’3ã€œ5å€‹ã€ç®‡æ¡æ›¸ãï¼ˆå…ˆé ­ã«ã€Œãƒ»ã€ï¼‰ã§å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚';

        const reqBody = JSON.stringify({
          contents: [{
            parts: [
              { text: prompt },
              { inline_data: { mime_type: mime, data: b64 } }
            ]
          }]
        });

        // ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚µã‚¤ã‚ºã‚’ç¢ºèªï¼ˆ20MBä¸Šé™ï¼‰
        const reqSizeMB = (reqBody.length / 1024 / 1024).toFixed(1);
        if (reqBody.length > 20 * 1024 * 1024) {
          throw new Error('ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚µã‚¤ã‚ºãŒå¤§ãã™ãã¾ã™ï¼ˆ' + reqSizeMB + 'MBï¼‰ã€‚\n20MBä»¥ä¸‹ã®éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„ã€‚');
        }
        document.getElementById('loadMsg').textContent = 'AIãŒè§£æä¸­...ï¼ˆãƒªã‚¯ã‚¨ã‚¹ãƒˆ: ' + reqSizeMB + 'MBï¼‰';

        // ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ: v1/models/gemini-1.5-flash:generateContent
        const url = API_BASE + '?key=' + apiKey;

        let res;
        try {
          res = await fetch(url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: reqBody
          });
        } catch (fetchErr) {
          throw new Error(
            'é€šä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆFailed to fetchï¼‰ã€‚\n\n' +
            'è€ƒãˆã‚‰ã‚Œã‚‹åŸå› :\n' +
            'â‘  ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆæ¥ç¶šã‚’ç¢ºèªã—ã¦ãã ã•ã„\n' +
            'â‘¡ éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ãŒå¤§ãã™ãã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ï¼ˆç¾åœ¨: ' + reqSizeMB + 'MBï¼‰\n' +
            'â‘¢ APIã‚­ãƒ¼ãŒæ­£ã—ã„ã‹ç¢ºèªã—ã¦ãã ã•ã„ï¼ˆç¾åœ¨ã®é•·ã•: ' + apiKey.length + 'æ–‡å­—ï¼‰\n\n' +
            'MIMEã‚¿ã‚¤ãƒ—: ' + mime + '\n' +
            'ãƒ•ã‚¡ã‚¤ãƒ«å: ' + pickedFile.name + '\n' +
            'ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚º: ' + (pickedFile.size / 1024 / 1024).toFixed(1) + 'MB\n\n' +
            'è©³ç´°: ' + fetchErr.message
          );
        }

        const json = await res.json();

        // ã‚¨ãƒ©ãƒ¼ãƒã‚§ãƒƒã‚¯
        if (!res.ok) {
          const code = json.error?.code || res.status;
          const msg = json.error?.message || JSON.stringify(json, null, 2);
          if (code === 401 || code === 403) throw new Error('APIã‚­ãƒ¼ãŒç„¡åŠ¹ã§ã™ã€‚è¨­å®šï¼ˆâš™ï¸ï¼‰ã‹ã‚‰å†å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚\n\n' + msg);
          if (code === 404) throw new Error('APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ (404)ã€‚\nãƒ¢ãƒ‡ãƒ«åã‚„APIãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒæ­£ã—ã„ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚\n\n' + msg);
          if (code === 429) throw new Error('APIåˆ©ç”¨åˆ¶é™ã«é”ã—ã¾ã—ãŸã€‚ã—ã°ã‚‰ãå¾…ã£ã¦ã‹ã‚‰å†è©¦è¡Œã—ã¦ãã ã•ã„ã€‚');
          throw new Error('APIã‚¨ãƒ©ãƒ¼ (' + code + '): ' + msg);
        }

        const text = json?.candidates?.[0]?.content?.parts?.[0]?.text;
        if (!text) {
          const reason = json?.candidates?.[0]?.finishReason;
          throw new Error('AIã‹ã‚‰ã®å¿œç­”ãŒç©ºã§ã™ã€‚' + (reason ? '(ç†ç”±: ' + reason + ')' : '') + '\n\n' + JSON.stringify(json, null, 2));
        }

        // 3) çµæœã‚’è¡¨ç¤º
        showResult(text);

      } catch (e) {
        console.error(e);
        showErr(e.message);
      } finally {
        loading.classList.add('hidden');
        btn.disabled = !pickedFile;
      }
    }

    // ===== çµæœã®ãƒ‘ãƒ¼ã‚¹ï¼†è¡¨ç¤º =====
    function showResult(raw) {
      document.getElementById('outRaw').textContent = raw;

      // ã€è¦‹å‡ºã—ã€‘ãƒ™ãƒ¼ã‚¹ã§ã‚»ã‚¯ã‚·ãƒ§ãƒ³åˆ†å‰²
      const sec = (label) => {
        const re = new RegExp('ã€' + label + 'ã€‘\\s*([\\s\\S]*?)(?=ã€|$)');
        const m = raw.match(re);
        return m ? m[1].trim() : '';
      };

      let summary = sec('è¦ç´„');
      let points = sec('è¦ç‚¹');
      let trans = sec('æ–‡å­—èµ·ã“ã—');

      // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼šãƒ‘ãƒ¼ã‚¹å¤±æ•—æ™‚ã¯å…¨æ–‡ã‚’ãã®ã¾ã¾è¡¨ç¤º
      if (!summary && !points && !trans) {
        trans = raw;
        summary = 'ï¼ˆã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’è‡ªå‹•æŠ½å‡ºã§ãã¾ã›ã‚“ã§ã—ãŸã€‚ä¸‹ã®ã€Œå…¨æ–‡ã‚’è¡¨ç¤ºã€ã¾ãŸã¯ã€ŒAIã®ç”Ÿãƒ¬ã‚¹ãƒãƒ³ã‚¹ã€ã‚’ã”ç¢ºèªãã ã•ã„ï¼‰';
        points = summary;
      }

      document.getElementById('outSummary').textContent = summary;
      document.getElementById('outPoints').textContent = points;
      document.getElementById('outFull').textContent = trans;

      const results = document.getElementById('results');
      results.classList.remove('hidden');
      results.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    // ===== ã‚¨ãƒ©ãƒ¼è¡¨ç¤º =====
    function showErr(msg) {
      document.getElementById('errMsg').textContent = msg;
      document.getElementById('errBox').classList.remove('hidden');
    }
    function hideErr() { document.getElementById('errBox').classList.add('hidden'); }

    // ===== ã‚³ãƒ”ãƒ¼ =====
    async function copyText(id, btn) {
      const text = document.getElementById(id).textContent;
      try { await navigator.clipboard.writeText(text); } catch {
        const ta = document.createElement('textarea');
        ta.value = text; ta.style.cssText = 'position:fixed;opacity:0';
        document.body.appendChild(ta); ta.select(); document.execCommand('copy');
        document.body.removeChild(ta);
      }
      const orig = btn.textContent;
      btn.textContent = 'âœ… æ¸ˆã¿';
      const t = document.getElementById('toast');
      t.classList.remove('hidden');
      setTimeout(() => { t.classList.add('hidden'); btn.textContent = orig; }, 1800);
    }

    // ===== å…¨çµæœã‚³ãƒ”ãƒ¼ =====
    async function copyAll(btn) {
      const summary = document.getElementById('outSummary').textContent;
      const points = document.getElementById('outPoints').textContent;
      const full = document.getElementById('outFull').textContent;
      const all = 'ã€è¦ç´„ã€‘\n' + summary + '\n\nã€è¦ç‚¹ã€‘\n' + points + '\n\nã€æ–‡å­—èµ·ã“ã—ã€‘\n' + full;
      try { await navigator.clipboard.writeText(all); } catch {
        const ta = document.createElement('textarea');
        ta.value = all; ta.style.cssText = 'position:fixed;opacity:0';
        document.body.appendChild(ta); ta.select(); document.execCommand('copy');
        document.body.removeChild(ta);
      }
      const orig = btn.innerHTML;
      btn.innerHTML = 'âœ… ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ';
      const t = document.getElementById('toast');
      t.classList.remove('hidden');
      setTimeout(() => { t.classList.add('hidden'); btn.innerHTML = orig; }, 1800);
    }

    // ===== åˆæœŸåŒ–ï¼šAPIã‚­ãƒ¼æœªè¨­å®šãªã‚‰è¨­å®šç”»é¢ã‚’è¡¨ç¤º =====
    if (!localStorage.getItem(LS_KEY)) openSettings();
  </script>
</body>

</html>
